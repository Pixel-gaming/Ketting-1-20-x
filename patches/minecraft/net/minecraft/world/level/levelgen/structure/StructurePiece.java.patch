--- a/net/minecraft/world/level/levelgen/structure/StructurePiece.java
+++ b/net/minecraft/world/level/levelgen/structure/StructurePiece.java
@@ -26,8 +_,8 @@
 import net.minecraft.world.level.block.Mirror;
 import net.minecraft.world.level.block.Rotation;
 import net.minecraft.world.level.block.entity.BlockEntity;
 import net.minecraft.world.level.block.entity.ChestBlockEntity;
 import net.minecraft.world.level.block.entity.DispenserBlockEntity;
 import net.minecraft.world.level.block.state.BlockState;
 import net.minecraft.world.level.chunk.ChunkGenerator;
 import net.minecraft.world.level.levelgen.Heightmap;
@@ -46,7 +_,7 @@
    private Rotation rotation;
    protected int genDepth;
    private final StructurePieceType type;
-   private static final Set<Block> SHAPE_CHECK_BLOCKS = ImmutableSet.<Block>builder().add(Blocks.NETHER_BRICK_FENCE).add(Blocks.TORCH).add(Blocks.WALL_TORCH).add(Blocks.OAK_FENCE).add(Blocks.SPRUCE_FENCE).add(Blocks.DARK_OAK_FENCE).add(Blocks.ACACIA_FENCE).add(Blocks.BIRCH_FENCE).add(Blocks.JUNGLE_FENCE).add(Blocks.LADDER).add(Blocks.IRON_BARS).build();
+   public static final Set<Block> SHAPE_CHECK_BLOCKS = ImmutableSet.<Block>builder().add(Blocks.NETHER_BRICK_FENCE).add(Blocks.TORCH).add(Blocks.WALL_TORCH).add(Blocks.OAK_FENCE).add(Blocks.SPRUCE_FENCE).add(Blocks.DARK_OAK_FENCE).add(Blocks.ACACIA_FENCE).add(Blocks.BIRCH_FENCE).add(Blocks.JUNGLE_FENCE).add(Blocks.LADDER).add(Blocks.IRON_BARS).build();
 
    protected StructurePiece(StructurePieceType p_209994_, int p_209995_, BoundingBox p_209996_) {
       this.type = p_209994_;
@@ -71,6 +_,9 @@
    }
 
    public final CompoundTag createTag(StructurePieceSerializationContext p_192645_) {
+      if (BuiltInRegistries.STRUCTURE_PIECE.getKey(this.getType()) == null) { // FORGE: Friendlier error then the Null String error below.
+         throw new RuntimeException("StructurePiece \"" + this.getClass().getName() + "\": \"" + this.getType() + "\" unregistered, serializing impossible.");
+      }
       CompoundTag compoundtag = new CompoundTag();
       compoundtag.putString("id", BuiltInRegistries.STRUCTURE_PIECE.getKey(this.getType()).toString());
       BoundingBox.CODEC.encodeStart(NbtOps.INSTANCE, this.boundingBox).resultOrPartial(LOGGER::error).ifPresent((p_163579_) -> {
@@ -171,6 +_,11 @@
             }
 
             p_73435_.setBlock(blockpos, p_73436_, 2);
+            // CraftBukkit start - fluid handling is already done if we have a transformer generator access
+            if (p_73435_ instanceof org.bukkit.craftbukkit.util.TransformerGeneratorAccess) {
+               return;
+            }
+            // CraftBukkit end
             FluidState fluidstate = p_73435_.getFluidState(blockpos);
             if (!fluidstate.isEmpty()) {
                p_73435_.scheduleTick(blockpos, fluidstate.getType(), 0);
@@ -184,6 +_,38 @@
       }
    }
 
+   // CraftBukkit start
+   protected boolean placeCraftBlockEntity(ServerLevelAccessor worldAccess, BlockPos position, org.bukkit.craftbukkit.block.CraftBlockEntityState<?> craftBlockEntityState, int i) {
+      if (worldAccess instanceof org.bukkit.craftbukkit.util.TransformerGeneratorAccess transformerAccess) {
+         return transformerAccess.setCraftBlock(position, craftBlockEntityState, i);
+      }
+      boolean result = worldAccess.setBlock(position, craftBlockEntityState.getHandle(), i);
+      BlockEntity tileEntity = worldAccess.getBlockEntity(position);
+      if (tileEntity != null) {
+         tileEntity.load(craftBlockEntityState.getSnapshotNBT());
+      }
+      return result;
+   }
+
+   protected void placeCraftSpawner(ServerLevelAccessor worldAccess, BlockPos position, org.bukkit.entity.EntityType entityType, int i) {
+      // This method is used in structures that are generated by code and place spawners as they set the entity after the block was placed making it impossible for plugins to access that information
+      org.bukkit.craftbukkit.block.CraftCreatureSpawner spawner = (org.bukkit.craftbukkit.block.CraftCreatureSpawner) org.bukkit.craftbukkit.block.CraftBlockStates.getBlockState(position, Blocks.SPAWNER.defaultBlockState(), null);
+      spawner.setSpawnedType(entityType);
+      placeCraftBlockEntity(worldAccess, position, spawner, i);
+   }
+
+   protected void setCraftLootTable(ServerLevelAccessor worldAccess, BlockPos position, RandomSource randomSource, net.minecraft.resources.ResourceLocation loottableKey) {
+      // This method is used in structures that use data markers to a loot table to loot containers as otherwise plugins won't have access to that information.
+      net.minecraft.world.level.block.entity.BlockEntity tileEntity = worldAccess.getBlockEntity(position);
+      if (tileEntity instanceof net.minecraft.world.level.block.entity.RandomizableContainerBlockEntity tileEntityLootable) {
+         tileEntityLootable.setLootTable(loottableKey, randomSource.nextLong());
+         if (worldAccess instanceof org.bukkit.craftbukkit.util.TransformerGeneratorAccess transformerAccess) {
+            transformerAccess.setCraftBlock(position, (org.bukkit.craftbukkit.block.CraftBlockState) org.bukkit.craftbukkit.block.CraftBlockStates.getBlockState(position, tileEntity.getBlockState(), tileEntityLootable.saveWithFullMetadata()), 3);
+         }
+      }
+   }
+   // CraftBukkit end
+
    protected boolean canBeReplaced(LevelReader p_163553_, int p_163554_, int p_163555_, int p_163556_, BoundingBox p_163557_) {
       return true;
    }
@@ -372,11 +_,19 @@
             p_226768_ = reorient(p_226763_, p_226766_, Blocks.CHEST.defaultBlockState());
          }
 
+         // CraftBukkit start
+         /*
          p_226763_.setBlock(p_226766_, p_226768_, 2);
          BlockEntity blockentity = p_226763_.getBlockEntity(p_226766_);
          if (blockentity instanceof ChestBlockEntity) {
             ((ChestBlockEntity)blockentity).setLootTable(p_226767_, p_226765_.nextLong());
          }
+         */
+         org.bukkit.craftbukkit.block.CraftChest chestState = (org.bukkit.craftbukkit.block.CraftChest) org.bukkit.craftbukkit.block.CraftBlockStates.getBlockState(p_226766_, p_226768_, null);
+         chestState.setLootTable(org.bukkit.Bukkit.getLootTable(org.bukkit.craftbukkit.util.CraftNamespacedKey.fromMinecraft(p_226767_)));
+         chestState.setSeed(p_226765_.nextLong());
+         placeCraftBlockEntity(p_226763_, p_226766_, chestState, 2);
+         // CraftBukkit end
 
          return true;
       } else {
@@ -385,13 +_,32 @@
    }
 
    protected boolean createDispenser(WorldGenLevel p_226820_, BoundingBox p_226821_, RandomSource p_226822_, int p_226823_, int p_226824_, int p_226825_, Direction p_226826_, ResourceLocation p_226827_) {
-      BlockPos blockpos = this.getWorldPos(p_226823_, p_226824_, p_226825_);
+      BlockPos.MutableBlockPos blockpos = this.getWorldPos(p_226823_, p_226824_, p_226825_);
       if (p_226821_.isInside(blockpos) && !p_226820_.getBlockState(blockpos).is(Blocks.DISPENSER)) {
+         // CraftBukkit start
+         /*
          this.placeBlock(p_226820_, Blocks.DISPENSER.defaultBlockState().setValue(DispenserBlock.FACING, p_226826_), p_226823_, p_226824_, p_226825_, p_226821_);
          BlockEntity blockentity = p_226820_.getBlockEntity(blockpos);
          if (blockentity instanceof DispenserBlockEntity) {
             ((DispenserBlockEntity)blockentity).setLootTable(p_226827_, p_226822_.nextLong());
          }
+         */
+         if (!this.canBeReplaced(p_226820_, p_226823_, p_226824_, p_226825_, p_226821_)) {
+            return true;
+         }
+         BlockState blockstate = Blocks.DISPENSER.defaultBlockState().setValue(DispenserBlock.FACING, p_226826_);
+         if (this.mirror != Mirror.NONE) {
+            blockstate = blockstate.mirror(this.mirror);
+         }
+         if (this.rotation != Rotation.NONE) {
+            blockstate = blockstate.rotate(this.rotation);
+         }
+
+         org.bukkit.craftbukkit.block.CraftDispenser dispenserState = (org.bukkit.craftbukkit.block.CraftDispenser) org.bukkit.craftbukkit.block.CraftBlockStates.getBlockState(blockpos, blockstate, null);
+         dispenserState.setLootTable(org.bukkit.Bukkit.getLootTable(org.bukkit.craftbukkit.util.CraftNamespacedKey.fromMinecraft(p_226827_)));
+         dispenserState.setSeed(p_226822_.nextLong());
+         placeCraftBlockEntity(p_226820_, blockpos, dispenserState, 2);
+         // CraftBukkit end
 
          return true;
       } else {
